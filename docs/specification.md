# みんなでパズル (みんパズ) プロジェクト仕様書

## 概要

みんパズは、リアルタイムで2チームが競い合う対戦型Webパズルゲームの開発プロジェクトです。

### ゲームルール
- **基本形式**: 2チームによる対戦形式の5x5ジグソーパズルです。
- **勝利条件**: 制限時間（2分）内に相手チームより先にパズルを完成させるか、タイムアップ時点での完成ピース数が相手チームを上回ることで勝利となります。
- **チームプレイ**: チームメンバーは同じ盤面を共有し、協力してピースを配置します。

## 機能要件

### ユーザーフロー

1.  **ホーム画面**: チームを作成するか、既存のチームに参加するかを選択します。
2.  **チーム作成**: 新しいチームを作成し、チーム待機画面に遷移します。発行されたチーム番号を他のメンバーに共有します。
3.  **チーム参加**: チーム番号を入力し、指定されたチームの待機画面に参加します。
4.  **チーム待機画面**: チームメンバーが集合し、準備が整ったらマッチングを開始します。
5.  **マッチング画面**: 対戦相手チームを探索します。
6.  **ゲーム画面**: マッチングが成立すると自動的に遷移します。
    -   チームで協力して5x5のジグソーパズルを完成させます。
    -   画面上部には残り時間と両チームのスコア（完成ピース数）が表示されます。
7.  **結果画面**: ゲーム終了後、勝敗結果と最終スコアが表示されます。

## 技術スタック

### フロントエンド
- **フレームワーク**: Next.js (App Router)
- **リアルタイム通信**: Socket.io-client
- **言語**: TypeScript
- **状態管理**: Zustand

### バックエンド
- **フレームワーク**: Node.js + Express.js
- **リアルタイム通信**: Socket.io
- **言語**: TypeScript
- **データアクセス**: Node-Redis, およびカスタムリポジトリ層

### データベース・インフラ
- **状態管理**: Redis (Upstash for Production, Docker for Local)
- **RDB**: Supabase PostgreSQL (永続化データ用、現在は部分的に利用)

## プロジェクト構成

```
project-root/
├── frontend/            # Next.js アプリケーション
│   └── src/
│       ├── app/         # App Router ページ
│       ├── features/    # 機能コンポーネント (Game, Team, etc.)
│       └── lib/         # 共通ライブラリ (Socket, Session, etc.)
├── backend/             # Express.js サーバー
│   ├── src/
│   │   ├── __tests__/   # Jest 結合・単体テスト
│   │   ├── config/      # DIコンテナなど
│   │   ├── controller/  # API コントローラー
│   │   ├── model/       # ドメインモデル (Game, Matching, Team)
│   │   ├── repository/  # データアクセス層 (Redis)
│   │   ├── routes/      # API ルート
│   │   ├── shared/      # 共有ユーティリティ
│   │   └── socket/      # Socket.io ハンドラー
│   └── Dockerfile
├── supabase/            # Supabaseローカル開発環境
└── docs/                # ドキュメント
```

## デプロイ・運用

### 本番環境
- **フロントエンド**: Vercel
- **バックエンド**: Render
- **Redis**: Upstash
- **PostgreSQL**: Supabase

### ローカル開発環境
- **データベース**: Supabase CLI (`supabase start`) で個別に起動。
- **その他サービス**: `docker-compose up` を使用し、Redis、バックエンド、フロントエンドを一括で起動。

### 開発フロー
1. 必要に応じて Supabase migrations を作成・適用。
2. `docker-compose up --build` で開発環境を起動。
3. アプリケーション開発とテストを実施。
4. Gitで変更をコミットし、mainブランチへのマージで自動デプロイ。

## CI/CD

- **デプロイ**: mainブランチへのプッシュをトリガーとして、Vercel (フロントエンド) と Render (バックエンド) で自動デプロイが実行されます。
- **環境設定**: 環境変数は各ホスティングサービスの管理画面で設定します。

## 主要設計要素

### リアルタイム通信
- WebSocket (Socket.io) を利用して、クライアントとサーバー間の状態をリアルタイムで同期します。
- 主な同期対象: チーム状態、ゲーム進行状況（ピース配置、スコア）、タイマー、マッチングステータス。

### マッチングポリシー
- **優先ルール**: 同じメンバー数のチーム同士を優先的にマッチングします。
- **フォールバック**: 適切なチームが見つからない場合、待機キューの先頭（FIFO）にいるチームとマッチングします。

### 状態管理
- **Redis**: ゲームの一時的な状態（セッション、マッチ情報、ピースの配置状況、スコアなど）をすべて管理します。サーバー再起動でデータは揮発します。
- **PostgreSQL (Supabase)**: 将来的にユーザーアカウントや戦績など、永続化が必要なデータを保存するために利用予定です。

### アーキテクチャパターン
- **関数型ドメインモデリング**: `neverthrow`ライブラリの`Result`型を活用し、エラー処理と副作用を明確に分離します。(詳細は `docs/typescript/fp.md` を参照)
- **リポジトリパターン**: Redisへのデータアクセスを`repository`層に集約し、ドメインロジックから具体的なデータ操作を分離します。
- **MVC (Model-View-Controller)**: Expressバックエンドでは、`routes` (Controller)、`model` (Model)、`repository` (Modelの一部) のように関心を分離しています。

## 今後の拡張性

### 機能拡張
- 複数ゲームモード対応（難易度変更など）
- ランキング・統計機能
- ユーザー認証とプロフィール機能
- 観戦機能